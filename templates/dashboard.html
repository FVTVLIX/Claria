{% extends "base.html" %}

{% block content %}
<h1 style="margin-bottom: 2rem;">Welcome, {{ current_user.username }}!</h1>

<div class="dashboard-grid">
    <!-- Chart Card -->
    <div class="card card-chart"
        style="position: relative; overflow: hidden; min-height: 400px; display: flex; flex-direction: column; align-items: center;">
        <div
            style="width: 100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3>Constellation of Habits</h3>
            <span class="text-muted" style="font-family: var(--font-mono); font-size: 0.8rem;">TAG vs MOOD</span>
        </div>

        <div style="position: relative; height: 350px; width: 100%; max-width: 500px;">
            <canvas id="habitChart"></canvas>
        </div>

        {% if not tag_analytics.data %}
        <div
            style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; background: rgba(255,255,255,0.9); padding: 2rem; border: 1px dashed #111;">
            <p>No patterns detected yet.</p>
            <small>Log your specific activities (e.g., "gym", "reading") to see them map here!</small>
        </div>
        {% endif %}
    </div>

    <!-- Log Mood Card -->
    <div class="card card-log">
        <h3>Log Mood</h3>
        <form action="{{ url_for('log_mood') }}" method="POST">
            <div class="mood-selector" style="justify-content: space-around;">
                <button class="mood-btn" data-score="1" title="Very Bad">üò¢</button>
                <button class="mood-btn" data-score="2" title="Bad">‚òπÔ∏è</button>
                <button class="mood-btn" data-score="3" title="Neutral">üòê</button>
                <button class="mood-btn" data-score="4" title="Good">üôÇ</button>
                <button class="mood-btn" data-score="5" title="Very Good">üòÅ</button>
            </div>
            <input type="hidden" id="mood-score" name="score" required>

            <div class="form-group">
                <input type="text" name="tags" placeholder="Tags (e.g., work, gym, sleep)" class="form-control"
                    autocomplete="off">
            </div>
            <div class="form-group">
                <textarea name="note" rows="2" placeholder="Note..." class="form-control"></textarea>
            </div>
            <button type="submit" class="btn-primary" style="width: 100%;">RECORD ENTRY</button>
        </form>
    </div>

    <!-- Recent History Card -->
    <div class="card card-history">
        <h3>Recent History</h3>
        {% if moods %}
        <div class="mood-list">
            {% for mood in moods %}
            <div
                style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding: 15px 0;">
                <div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.5rem;">
                            {% if mood.score == 1 %}üò¢{% elif mood.score == 2 %}‚òπÔ∏è{% elif mood.score == 3 %}üòê{%
                            elif mood.score == 4 %}üôÇ{% else %}üòÅ{% endif %}
                        </span>
                        <span style="font-weight: 700; font-family: var(--font-mono);">
                            {{ mood.timestamp.strftime('%B %d') }}
                        </span>
                        <span style="font-size: 0.8rem; color: #888;">{{ mood.timestamp.strftime('%H:%M') }}</span>
                    </div>

                    {% if mood.tags %}
                    <div style="margin-top: 5px; margin-left: 0;">
                        {% for tag in mood.tags.split(',') %}
                        {% if tag.strip() %}
                        <span class="suggestion-chip"
                            style="font-size: 0.7rem; padding: 2px 8px; cursor: default; margin-right: 5px;">{{
                            tag.strip() }}</span>
                        {% endif %}
                        {% endfor %}
                    </div>
                    {% endif %}

                    {% if mood.note %}
                    <p
                        style="margin: 8px 0 0 0; color: var(--text-main); font-style: italic; border-left: 2px solid var(--accent-color); padding-left: 10px;">
                        "{{ mood.note }}"
                    </p>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-muted">No mood entries yet. Start tracking above!</p>
        {% endif %}
    </div>

    <!-- Oracle Card -->
    <div class="card card-oracle" style="text-align: center;">
        <i class="fa-solid fa-eye fa-3x" style="color: var(--text-main); margin-bottom: 1rem;"></i>
        <h3>The Oracle</h3>
        <p style="margin-bottom: 1rem;">Seek guidance from your AI companion.</p>
        <a href="{{ url_for('chat') }}" class="btn-secondary" style="width: 60%;">ENTER CHAT</a>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const ctx = document.getElementById('habitChart').getContext('2d');

        // Data passed from Flask
        const habitLabels = {{ tag_analytics.labels | tojson
    }};
    const dataPoints = {{ tag_analytics.data | tojson }};

    // Robust Palette Colors (10 distinct colors)
    const backgroundColors = [
        'rgba(255, 99, 132, 0.7)',   // Red
        'rgba(54, 162, 235, 0.7)',   // Blue
        'rgba(255, 206, 86, 0.7)',   // Yellow
        'rgba(75, 192, 192, 0.7)',   // Teal
        'rgba(153, 102, 255, 0.7)',  // Purple
        'rgba(255, 159, 64, 0.7)',   // Orange
        'rgba(199, 199, 199, 0.7)',  // Grey
        'rgba(83, 102, 255, 0.7)',   // Indigo
        'rgba(40, 167, 69, 0.7)',    // Green
        'rgba(212, 175, 55, 0.7)'    // Gold
    ];

    const borderColors = [
        'rgba(255, 99, 132, 1)',
        'rgba(54, 162, 235, 1)',
        'rgba(255, 206, 86, 1)',
        'rgba(75, 192, 192, 1)',
        'rgba(153, 102, 255, 1)',
        'rgba(255, 159, 64, 1)',
        'rgba(199, 199, 199, 1)',
        'rgba(83, 102, 255, 1)',
        'rgba(40, 167, 69, 1)',
        'rgba(212, 175, 55, 1)'
    ];

    new Chart(ctx, {
        type: 'polarArea',
        data: {
            labels: habitLabels,
            datasets: [{
                label: 'Avg Mood Score',
                data: dataPoints,
                backgroundColor: backgroundColors,
                borderColor: borderColors,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: {
                    beginAtZero: true,
                    max: 5,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)',
                        circular: true
                    },
                    ticks: {
                        display: false // Hide numbers for cleaner aesthetic
                    },
                    pointLabels: {
                        font: {
                            family: "'Space Mono', monospace",
                            size: 12
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        font: {
                            family: "'Space Mono', monospace"
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            return ' Avg Mood: ' + context.raw;
                        }
                    },
                    backgroundColor: '#111',
                    titleFont: { family: "'Space Mono', monospace" },
                    bodyFont: { family: "'Inter', sans-serif" }
                }
            },
            animation: {
                animateRotate: true,
                animateScale: true,
                duration: 2000,
                easing: 'easeOutQuart'
            }
        }
    });
    });
</script>
{% endblock %}